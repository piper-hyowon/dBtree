---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.18.0
  name: dbinstances.dbtree.cloud
spec:
  group: dbtree.cloud
  names:
    kind: DBInstance
    listKind: DBInstanceList
    plural: dbinstances
    shortNames:
    - dbi
    singular: dbinstance
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.type
      name: DB Type
      type: string
    - jsonPath: .spec.size
      name: Size
      type: string
    - jsonPath: .spec.mode
      name: Mode
      type: string
    - jsonPath: .status.state
      name: Status
      type: string
    - jsonPath: .status.endpoint
      name: Endpoint
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1
    schema:
      openAPIV3Schema:
        description: DBInstance is the Schema for the dbinstances API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              DBInstanceSpec defines the desired state of DBInstance
              Maps to backend's CreateInstanceRequest
            properties:
              backup:
                description: Backup configuration
                properties:
                  enabled:
                    description: Enable automatic backups
                    type: boolean
                  retentionDays:
                    description: Retention days for backups
                    format: int32
                    maximum: 90
                    minimum: 1
                    type: integer
                  schedule:
                    description: |-
                      Backup schedule in cron format
                      Standard cron format: minute hour day month weekday
                      Examples: "0 2 * * *" (daily at 2am), "*/30 * * * *" (every 30 minutes)
                    type: string
                  storageSize:
                    default: 10Gi
                    description: Storage size for backup PVC (e.g., "10Gi")
                    type: string
                required:
                - enabled
                type: object
              config:
                description: Configuration map (matches backend Config field)
                type: object
                x-kubernetes-preserve-unknown-fields: true
              createdFromPreset:
                description: Created from preset ID (optional, matches backend)
                type: string
              externalId:
                description: ExternalID from backend (백엔드의 DBInstance.ExternalID)
                type: string
              mode:
                description: Deployment mode
                enum:
                - standalone
                - replica_set
                - sharded
                - basic
                - sentinel
                - cluster
                type: string
              name:
                description: Instance name (3-50 chars as per backend validation)
                maxLength: 50
                minLength: 3
                type: string
              resources:
                description: Compute resources
                properties:
                  cpu:
                    description: CPU in cores (matches backend)
                    format: int32
                    minimum: 1
                    type: integer
                  disk:
                    description: Disk in GB (matches backend)
                    format: int32
                    minimum: 1
                    type: integer
                  memory:
                    description: Memory in MB (matches backend)
                    format: int32
                    minimum: 128
                    type: integer
                required:
                - cpu
                - disk
                - memory
                type: object
              secretRef:
                description: Reference to the credentials secret
                properties:
                  name:
                    default: ""
                    description: |-
                      Name of the referent.
                      This field is effectively required, but due to backwards compatibility is
                      allowed to be empty. Instances of this type with an empty value here are
                      almost certainly wrong.
                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                    type: string
                type: object
                x-kubernetes-map-type: atomic
              size:
                description: Instance size
                enum:
                - small
                - medium
                - large
                type: string
              type:
                description: Database type
                enum:
                - mongodb
                - redis
                type: string
              userId:
                description: UserID is the owner (matches backend)
                type: string
            required:
            - backup
            - externalId
            - mode
            - name
            - resources
            - secretRef
            - size
            - type
            - userId
            type: object
          status:
            description: |-
              DBInstanceStatus defines the observed state of DBInstance
              Maps to backend's DBInstance runtime fields
            properties:
              conditions:
                description: Standard K8s conditions
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              endpoint:
                description: Connection endpoint
                type: string
              k8sNamespace:
                description: 'K8s namespace (backend: K8sNamespace)'
                type: string
              k8sResourceName:
                description: 'K8s resource name (backend: K8sResourceName)'
                type: string
              lastBilledAt:
                description: 'Last billing time (backend: LastBilledAt)'
                format: date-time
                type: string
              lastMetricsUpdate:
                description: Last metrics update time
                format: date-time
                type: string
              metrics:
                description: Runtime metrics
                properties:
                  connections:
                    description: Active connections count
                    format: int32
                    type: integer
                  cpuUsage:
                    description: CPU usage percentage (string to match CRD)
                    type: string
                  diskUsage:
                    description: Disk usage percentage
                    type: string
                  memoryUsage:
                    description: Memory usage percentage
                    type: string
                  operationsPerSecond:
                    description: Operations per second
                    format: int32
                    type: integer
                type: object
              observedGeneration:
                description: ObservedGeneration for reconciliation optimization
                format: int64
                type: integer
              pausedAt:
                description: 'Paused timestamp (backend: PausedAt)'
                format: date-time
                type: string
              port:
                description: Service port
                format: int32
                type: integer
              secretRef:
                description: Reference to credentials secret
                type: string
              state:
                description: Current state
                enum:
                - provisioning
                - running
                - stopped
                - paused
                - error
                - deleting
                - maintenance
                - backing_up
                - restoring
                - upgrading
                type: string
              statusReason:
                description: Reason for current state
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
